name: Publish to crates.io

on:
  push:
    branches:
      - main

env:
  CARGO_TERM_COLOR: always
  CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Publish crates
        run: |
          try_publish() {
            local output
            output=$(cargo publish -p "$1" 2>&1) && echo "$output" || {
              echo "$output"
              echo "$output" | grep -q "already exists"
            }
          }
          try_publish pbzx
          try_publish xara
          try_publish hfsplus
          try_publish udif
          sleep 30
          try_publish dpp
          sleep 30
          try_publish dpp-tool